<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOD PRO - Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        :root {
            --bg: #020617;
            --rose: #f43f5e;
            --indigo: #6366f1;
        }

        body { 
            background: var(--bg); 
            color: white; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        .glass { 
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            backdrop-filter: blur(25px); 
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .btn-tap:active { transform: scale(0.96); }
        
        .my-msg { 
            background: linear-gradient(135deg, var(--indigo) 0%, #4338ca 100%); 
            border-radius: 1.5rem 1.5rem 0.2rem 1.5rem; 
        }

        .their-msg { 
            background: rgba(255, 255, 255, 0.07); 
            border-radius: 1.5rem 1.5rem 1.5rem 0.2rem; 
        }

        /* View Once Styles */
        .view-once-card {
            background: rgba(244, 63, 94, 0.1);
            border: 1px dashed rgba(244, 63, 94, 0.4);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-once-card:hover { background: rgba(244, 63, 94, 0.15); }

        .view-once-opened {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.2);
        }

        /* Animations */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { 
            width: 24px; height: 24px; 
            border: 3px solid rgba(255,255,255,0.1); 
            border-top-color: var(--rose); 
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
        }

        #viewer-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0,0,0,0.98);
            backdrop-filter: blur(20px);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
    </style>
</head>
<body>

    <!-- SCREEN LOGIN -->
    <div id="v-login" class="fixed inset-0 z-[100] bg-slate-950 flex flex-col items-center justify-center p-8">
        <div class="mb-10 text-center">
            <h1 class="text-7xl font-black italic tracking-tighter uppercase leading-none">TOD <span class="text-rose-500">PRO</span></h1>
            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-[0.5em] mt-2">Privacy & Fun Guaranteed</p>
        </div>
        <div class="glass p-8 rounded-[3rem] w-full max-w-xs space-y-4">
            <input id="in-nick" type="text" maxlength="12" placeholder="Siapa namamu?" class="w-full p-5 rounded-2xl bg-slate-900 border border-white/10 text-white text-center font-bold outline-none focus:ring-2 ring-rose-500/50 transition-all">
            <button onclick="startApp()" class="w-full bg-white p-5 rounded-2xl text-slate-950 font-black uppercase tracking-widest btn-tap">Mulai Bermain</button>
        </div>
    </div>

    <!-- VIEWER MODAL (VIEW ONCE) -->
    <div id="viewer-modal" onclick="closeViewer()">
        <div class="text-center w-full max-w-lg">
            <img id="viewer-img" src="" class="w-full h-auto rounded-[2rem] shadow-2xl border border-white/10 mb-6">
            <p class="text-[10px] font-black uppercase tracking-[0.3em] text-rose-500 animate-pulse">Pesan Ini Telah Hangus</p>
            <p class="text-white/30 text-[9px] mt-4 uppercase">Ketuk di mana saja untuk kembali</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="v-main" class="flex-1 flex flex-col hidden overflow-hidden relative">
        
        <!-- HEADER -->
        <header class="px-6 py-4 flex justify-between items-center shrink-0 glass m-2 rounded-3xl border-none shadow-xl">
            <div class="flex items-center gap-3">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <h1 class="font-black italic text-lg tracking-tighter">TOD PRO</h1>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleHistory(true)" class="p-3 glass rounded-xl text-white/40 btn-tap">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                </button>
                <button onclick="wipeOutSystem()" class="p-3 bg-rose-500/10 border border-rose-500/20 rounded-xl text-rose-500 btn-tap">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                </button>
            </div>
        </header>

        <!-- GAME CARD -->
        <div class="px-4 py-2 shrink-0">
            <div class="glass p-8 rounded-[3rem] text-center border-white/5 shadow-2xl relative overflow-hidden">
                <div id="g-label" class="text-[8px] font-black text-slate-500 uppercase tracking-[0.5em] mb-3">Tantangan Terbaru</div>
                
                <div class="min-h-[6rem] flex items-center justify-center mb-6">
                    <div id="g-loader" class="hidden"><div class="spinner"></div></div>
                    <h2 id="g-isi" class="text-xl font-bold italic text-slate-100 px-4 leading-tight uppercase tracking-tighter">"Siap Untuk Jujur atau Tantangan?"</h2>
                </div>

                <button id="btn-draw" onclick="drawChallenge()" class="w-full bg-white p-5 rounded-2xl text-slate-950 font-black text-[11px] uppercase tracking-widest btn-tap">
                    Acak Tantangan
                </button>
            </div>
        </div>

        <!-- CHAT SECTION -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <div id="c-list" class="flex-1 overflow-y-auto p-5 space-y-5 no-scrollbar flex flex-col-reverse"></div>
            
            <!-- INPUT AREA -->
            <div class="p-5 glass rounded-t-[3.5rem] border-t-0 shadow-2xl">
                <div class="flex flex-col gap-4">
                    
                    <div class="flex justify-between items-center px-4">
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" id="check-once" class="hidden peer">
                            <div class="w-10 h-5 bg-slate-800 rounded-full relative peer-checked:bg-rose-600 transition-all border border-white/5">
                                <div class="absolute top-1 left-1 w-3 h-3 bg-white rounded-full transition-all peer-checked:translate-x-5"></div>
                            </div>
                            <span class="text-[9px] font-black uppercase tracking-widest text-slate-500 peer-checked:text-rose-500 group-hover:text-slate-300 transition-all">Fitur Sekali Lihat</span>
                        </label>
                        <span id="up-status" class="hidden text-[8px] font-black text-indigo-400 animate-pulse uppercase">Proses Upload...</span>
                    </div>

                    <div class="flex items-center gap-3">
                        <input type="file" id="in-file" accept="image/*" class="hidden" onchange="handleFileUpload(this)">
                        <button onclick="document.getElementById('in-file').click()" class="p-5 rounded-full bg-white/5 text-white/40 btn-tap border border-white/5">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/><polyline points="16 5 21 5 21 10"/><line x1="12" y1="12" x2="21" y2="3"/></svg>
                        </button>
                        
                        <form onsubmit="event.preventDefault(); sendMessage();" class="flex-1 flex gap-3">
                            <input id="c-input" type="text" autocomplete="off" placeholder="Ketik pesan rahasia..." class="flex-1 bg-slate-900/50 border border-white/5 rounded-full px-8 py-5 text-sm outline-none focus:ring-2 ring-indigo-500/20 transition-all">
                            <button type="submit" class="bg-indigo-600 p-5 rounded-full btn-tap shadow-lg shadow-indigo-500/20">
                                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3.5"><polyline points="22 2 11 13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="history-modal" class="fixed inset-0 z-[60] bg-black/95 backdrop-blur-2xl hidden flex-col">
        <div class="p-8 flex justify-between items-center border-b border-white/5">
            <div>
                <h3 class="font-black text-xs tracking-widest uppercase">Riwayat TOD</h3>
                <p class="text-[8px] text-white/20 uppercase mt-1">Daftar tantangan yang sudah keluar</p>
            </div>
            <button onclick="toggleHistory(false)" class="p-3 glass rounded-2xl text-white/40 btn-tap">TUTUP</button>
        </div>
        <div id="history-list" class="flex-1 overflow-y-auto p-8 space-y-4 no-scrollbar"></div>
    </div>

    <script>
        // --- KONFIGURASI SUPABASE ---
        const SB_URL = 'https://rruxlxoeelxjjjmhafkc.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJydXhseG9lZWx4ampqbWhhZmtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NDU5OTMsImV4cCI6MjA4NTMyMTk5M30.oR2hl_BDD1P6Dmtos2So-aJ_eoFl1-Kwybt6mQnvq0Q';
        const supa = supabase.createClient(SB_URL, SB_KEY);

        let nick = "";
        let openedItems = JSON.parse(localStorage.getItem('tod_opened_v3')) || [];

        const DATA = {
            TRUTH: [
                "Siapa orang yang terakhir kamu kepoin di sosmed?",
                "Pernah bohong soal hal besar di grup ini?",
                "Siapa orang di sini yang paling ingin kamu hapus kontaknya?",
                "Sebutkan satu hal memalukan yang belum pernah kamu ceritakan.",
                "Pernah pura-pura suka kado yang aslinya jelek?",
                "Kapan terakhir kali kamu menangis dan karena apa?"
            ],
            DARE: [
                "Screenshot riwayat transfer terakhir di m-banking.",
                "VN suara desahan paling lucu ke grup ini.",
                "Tunjukkan isi chat WhatsApp teratas sekarang.",
                "Telepon mantan dan bilang 'Aku masih sayang' lalu matikan.",
                "Tirukan gaya bicara salah satu orang di sini sampai mereka menebak.",
                "Selfie muka paling jelek dan kirim sebagai bukti foto."
            ]
        };

        async function startApp() {
            nick = document.getElementById('in-nick').value.trim();
            if(!nick) return;
            document.getElementById('v-login').classList.add('hidden');
            document.getElementById('v-main').classList.remove('hidden');
            
            await supa.auth.signInAnonymously();
            
            // Realtime Sync
            supa.channel('tod_v3')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'Pesan' }, fetchChat)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'Tantangan' }, fetchGame)
                .subscribe();

            fetchChat(); fetchGame();
        }

        async function sendMessage(manualVal = null) {
            const input = document.getElementById('c-input');
            const onceCheck = document.getElementById('check-once');
            let text = manualVal || input.value.trim();
            if(!text) return;

            // Fitur Sekali Lihat
            if(onceCheck.checked) {
                text = `ONCE:${text}`;
                onceCheck.checked = false;
            }

            await supa.from('Pesan').insert([{ nama: nick, teks: text }]);
            input.value = "";
        }

        async function handleFileUpload(el) {
            const file = el.files[0];
            if(!file) return;

            const status = document.getElementById('up-status');
            status.classList.remove('hidden');

            const fileName = `proof_${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
            const { data, error } = await supa.storage.from('bukti').upload(fileName, file);

            if(!error) {
                const { data: publicUrl } = supa.storage.from('bukti').getPublicUrl(fileName);
                // Kita sertakan ?file= untuk mempermudah penghapusan storage nantinya
                await sendMessage(`IMG:${publicUrl.publicUrl}?file=${fileName}`);
            } else {
                alert("Upload Gagal: " + error.message);
            }

            status.classList.add('hidden');
            el.value = "";
        }

        async function fetchChat() {
            const { data } = await supa.from('Pesan').select('*').order('id', { ascending: false }).limit(40);
            const box = document.getElementById('c-list');
            box.innerHTML = "";
            
            data?.forEach(msg => {
                const isMe = msg.nama === nick;
                const isOnce = msg.teks.startsWith('ONCE:');
                const rawContent = isOnce ? msg.teks.replace('ONCE:', '') : msg.teks;
                const isImg = rawContent.startsWith('IMG:');
                const isOpened = openedItems.includes(msg.id);

                const container = document.createElement('div');
                container.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} w-full animate-in fade-in slide-in-from-bottom-2 duration-300`;

                let innerHtml = "";
                if (isOnce && isOpened) {
                    innerHtml = `<div class="view-once-opened px-5 py-4 rounded-3xl text-[10px] font-black uppercase tracking-widest italic">Pesan Telah Hangus</div>`;
                } else if (isOnce) {
                    innerHtml = `
                    <div onclick="openViewOnce('${msg.id}', '${rawContent}')" class="view-once-card px-6 py-4 rounded-3xl flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full bg-rose-500 animate-pulse"></div>
                        <span class="text-[10px] font-black uppercase tracking-widest text-rose-500">Buka Rahasia</span>
                    </div>`;
                } else {
                    if (isImg) {
                        const cleanUrl = rawContent.replace('IMG:', '').split('?')[0];
                        innerHtml = `<div class="${isMe ? 'my-msg' : 'their-msg'} p-1.5 border border-white/5 shadow-xl"><img src="${cleanUrl}" class="rounded-2xl max-w-full h-auto" loading="lazy"></div>`;
                    } else {
                        innerHtml = `<div class="${isMe ? 'my-msg' : 'their-msg'} px-6 py-4 text-[14px] border border-white/5 leading-relaxed">${rawContent}</div>`;
                    }
                }

                container.innerHTML = `
                    <span class="text-[7px] font-black text-white/10 mb-1.5 px-3 uppercase tracking-tighter">${msg.nama}</span>
                    <div class="max-w-[85%]">${innerHtml}</div>
                `;
                box.appendChild(container);
            });
        }

        function openViewOnce(id, raw) {
            const isImg = raw.startsWith('IMG:');
            const data = isImg ? raw.replace('IMG:', '').split('?')[0] : raw;

            if (isImg) {
                document.getElementById('viewer-img').src = data;
                document.getElementById('viewer-modal').style.display = 'flex';
            } else {
                alert(`PESAN RAHASIA DARI ${nick}:\n\n"${data}"\n\n(Pesan ini akan hangus setelah kamu klik OK)`);
            }

            openedItems.push(id);
            localStorage.setItem('tod_opened_v3', JSON.stringify(openedItems));
            fetchChat();
        }

        function closeViewer() {
            document.getElementById('viewer-modal').style.display = 'none';
            document.getElementById('viewer-img').src = "";
        }

        async function drawChallenge() {
            const btn = document.getElementById('btn-draw');
            const loader = document.getElementById('g-loader');
            const content = document.getElementById('g-isi');

            btn.disabled = true;
            content.classList.add('hidden');
            loader.classList.remove('hidden');

            setTimeout(async () => {
                const category = Math.random() > 0.5 ? 'TRUTH' : 'DARE';
                const options = DATA[category];
                const selected = options[Math.floor(Math.random() * options.length)];
                
                await supa.from('Tantangan').insert([{ tipe: category, isi: selected, pembuat: nick }]);
                
                loader.classList.add('hidden');
                content.classList.remove('hidden');
                btn.disabled = false;
            }, 1200);
        }

        async function fetchGame() {
            const { data } = await supa.from('Tantangan').select('*').order('id', { ascending: false }).limit(1);
            if(data?.[0]) {
                document.getElementById('g-label').innerText = `Oleh: ${data[0].pembuat}`;
                document.getElementById('g-isi').innerText = `[${data[0].tipe}] ${data[0].isi}`;
            }
        }

        async function wipeOutSystem() {
            const confirm1 = confirm("⚠️ PERINGATAN KERAS!\nSemua chat dan riwayat tantangan akan dihapus.");
            if(!confirm1) return;
            const confirm2 = confirm("Apakah kamu juga ingin menghapus SEMUA FOTO BUKTI di server selamanya?");
            if(!confirm2) return;

            // 1. Ambil data pesan untuk identifikasi file storage
            const { data: messages } = await supa.from('Pesan').select('teks');
            const filesToRemove = [];
            
            messages?.forEach(m => {
                if(m.teks.includes('?file=')) {
                    const name = m.teks.split('?file=')[1];
                    if(name) filesToRemove.push(name);
                }
            });

            // 2. Hapus fisik file di Storage
            if(filesToRemove.length > 0) {
                await supa.storage.from('bukti').remove(filesToRemove);
            }

            // 3. Hapus data di Database
            await supa.from('Pesan').delete().neq('id', 0);
            await supa.from('Tantangan').delete().neq('id', 0);
            
            // 4. Bersihkan local memory
            localStorage.removeItem('tod_opened_v3');
            openedItems = [];
            
            alert("Sistem Dibersihkan! Semua data dan file telah lenyap.");
            location.reload();
        }

        function toggleHistory(show) {
            const modal = document.getElementById('history-modal');
            modal.style.display = show ? 'flex' : 'none';
            if(show) fetchHistory();
        }

        async function fetchHistory() {
            const { data } = await supa.from('Tantangan').select('*').order('id', { ascending: false });
            const list = document.getElementById('history-list');
            list.innerHTML = data?.length ? "" : `<div class="text-center py-20 opacity-20 text-[10px] font-black uppercase tracking-[1em]">Kosong</div>`;
            
            data?.forEach(h => {
                const item = document.createElement('div');
                item.className = "p-6 glass rounded-[2rem] border-white/5";
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[8px] font-black uppercase tracking-widest ${h.tipe === 'TRUTH' ? 'text-indigo-400' : 'text-rose-400'}">${h.tipe}</span>
                        <span class="text-[7px] font-black text-white/10 italic">${new Date(h.created_at).toLocaleTimeString()}</span>
                    </div>
                    <p class="text-sm font-bold text-slate-200 leading-tight">"${h.isi}"</p>
                    <p class="text-[7px] font-black uppercase tracking-widest text-white/20 mt-4">Pemutar: ${h.pembuat}</p>
                `;
                list.appendChild(item);
            });
        }
    </script>
</body>
</html>

