<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOD - Random Only</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { background: #020617; color: white; font-family: 'Plus Jakarta Sans', sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .glass { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(25px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .btn-tap:active { transform: scale(0.96); }
        .my-msg { background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%); border-bottom-right-radius: 4px !important; }
        .their-msg { background: rgba(255, 255, 255, 0.05); border-bottom-left-radius: 4px !important; }
        .gradient-text { background: linear-gradient(to right, #f8fafc, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Tombol Utama - Danger Style */
        .btn-main { background: linear-gradient(135deg, #ef4444 0%, #991b1b 100%); box-shadow: 0 10px 30px -10px rgba(239, 68, 68, 0.5); }
        
        .spinner { width: 28px; height: 28px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #ef4444; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #main-menu { transition: all 0.2s ease; transform: scale(0.95) translateY(-10px); opacity: 0; pointer-events: none; }
        #main-menu.active { transform: scale(1) translateY(0); opacity: 1; pointer-events: auto; }

        .modal-overlay { transition: all 0.2s ease-in-out; opacity: 0; pointer-events: none; visibility: hidden; position: fixed; inset: 0; z-index: 60; background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); }
        .modal-overlay.active { opacity: 1; pointer-events: auto; visibility: visible; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="v-login" class="fixed inset-0 z-[100] bg-slate-950 flex flex-col items-center justify-center p-8 space-y-10">
        <div class="text-center">
            <h1 class="text-8xl font-black italic tracking-tighter gradient-text">TOD</h1>
            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-[0.6em] mt-2">Pure Random Edition</p>
        </div>
        <div class="glass p-8 rounded-[3rem] w-full max-w-xs space-y-5">
            <input id="in-nick" type="text" maxlength="15" placeholder="Namamu..." class="w-full p-4 rounded-2xl bg-slate-900 border border-white/5 text-white text-center font-bold outline-none focus:ring-2 ring-red-500 transition-all">
            <button onclick="start()" class="w-full bg-slate-100 p-4 rounded-2xl text-slate-950 font-black uppercase tracking-widest btn-tap">Masuk</button>
        </div>
    </div>

    <!-- MAIN -->
    <div id="v-main" class="flex-1 flex flex-col hidden overflow-hidden relative">
        
        <!-- HEADER -->
        <div class="px-6 py-5 flex justify-between items-center shrink-0 z-50">
            <button onclick="toggleHistory(true)" class="p-2.5 glass rounded-full text-slate-400 btn-tap border-white/5">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>
            </button>
            <h1 class="font-black italic text-2xl tracking-tighter gradient-text">TOD</h1>
            <div class="relative">
                <button onclick="toggleMenu()" class="p-2.5 glass rounded-full text-slate-400 btn-tap border-white/5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                </button>
                <div id="main-menu" class="absolute right-0 mt-3 w-48 glass border-white/10 rounded-2xl overflow-hidden shadow-2xl z-50">
                    <button onclick="resetGame()" class="w-full text-left px-5 py-4 text-[10px] font-black uppercase tracking-widest text-rose-400 border-b border-white/5">Reset Riwayat Game</button>
                    <button onclick="resetChat()" class="w-full text-left px-5 py-4 text-[10px] font-black uppercase tracking-widest text-rose-500">Reset Riwayat Chat</button>
                </div>
            </div>
        </div>

        <!-- GAME AREA -->
        <div class="p-4 shrink-0 pt-0">
            <div class="glass p-8 rounded-[2.5rem] text-center border-white/5 shadow-2xl relative">
                <div id="g-tipe" class="text-[9px] font-black text-slate-500 uppercase tracking-[0.4em] mb-2">Sistem Menentukan...</div>
                
                <div class="min-h-[7rem] flex flex-col items-center justify-center py-2">
                    <div id="loading-box" class="hidden flex flex-col items-center space-y-3">
                        <div class="spinner"></div>
                        <span class="text-[10px] font-black uppercase tracking-[0.5em] text-red-500 animate-pulse">Mengacak...</span>
                    </div>
                    <div id="display-content" class="space-y-2">
                        <div id="g-badge" class="hidden inline-block px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-tighter mb-2"></div>
                        <h2 id="g-isi" class="text-xl font-bold italic px-4 leading-snug text-slate-100 uppercase tracking-tighter">"Ketuk Tombol di Bawah"</h2>
                    </div>
                </div>
                
                <div class="mt-4">
                    <button id="btn-draw" onclick="drawChallenge()" class="btn-main w-full py-5 rounded-2xl font-black text-white text-xs btn-tap uppercase tracking-[0.4em] disabled:opacity-50">
                        Ambil Tantangan
                    </button>
                </div>
            </div>
        </div>

        <!-- CHAT AREA -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <div id="c-list" class="flex-1 overflow-y-auto p-4 space-y-6 no-scrollbar flex flex-col-reverse"></div>
            <div class="p-4 glass rounded-t-[3rem] border-t-0 shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
                <form onsubmit="event.preventDefault(); sendMsg();" class="flex gap-2">
                    <input id="c-input" type="text" placeholder="Ketik pesan..." class="flex-1 bg-slate-900 border border-white/5 rounded-full px-6 py-4 text-sm focus:outline-none">
                    <button type="submit" class="bg-white p-4 rounded-full btn-tap shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="#000" stroke="#000" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                    </button>
                </form>
            </div>
        </div>

        <!-- HISTORY MODAL -->
        <div id="history-modal" class="modal-overlay flex items-end justify-center px-4">
            <div id="history-content" class="glass w-full max-w-lg h-[85dvh] rounded-t-[3.5rem] flex flex-col overflow-hidden border-white/10 shadow-2xl">
                <div class="p-8 flex justify-between items-center border-b border-white/5">
                    <h3 class="font-black text-white uppercase tracking-[0.3em] text-[10px]">Arsip Permainan</h3>
                    <button onclick="toggleHistory(false)" class="p-2 glass rounded-full text-white/40">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
                <div id="history-list" class="flex-1 overflow-y-auto p-6 space-y-4 no-scrollbar pb-24"></div>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://rruxlxoeelxjjjmhafkc.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJydXhseG9lZWx4ampqbWhhZmtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NDU5OTMsImV4cCI6MjA4NTMyMTk5M30.oR2hl_BDD1P6Dmtos2So-aJ_eoFl1-Kwybt6mQnvq0Q';
        const supa = supabase.createClient(SB_URL, SB_KEY);
        let nick = "";

        // BANK DATA
        const BANK = {
            TRUTH: [
                "Siapa yang paling ingin kamu cium di ruangan ini?",
                "Apa rahasia terbesar yang belum pernah kamu ceritakan?",
                "Pernahkah kamu pura-pura sakit demi menghindari janji?",
                "Kapan terakhir kali kamu menangis dan kenapa?",
                "Siapa orang terakhir yang kamu stalk di Instagram?",
                "Apa hal paling ilegal yang pernah kamu lakukan?",
                "Sebutkan satu hal yang kamu benci dari orang di sebelah kananmu.",
                "Pernahkah kamu buang air di kolam renang?",
                "Siapa mantan yang paling sulit kamu lupakan?",
                "Apa fantasi teraneh yang pernah kamu miliki?"
            ],
            DARE: [
                "Biarkan orang di sebelah kiri menggambar sesuatu di wajahmu.",
                "Pesan makanan di ojek online tapi batalkan dalam 30 detik (jangan keterlaluan).",
                "Peragakan cara orang melahirkan selama 1 menit.",
                "Minum campuran air, garam, dan merica dalam satu gelas.",
                "Tunjukkan riwayat chat terakhirmu dengan orang tua.",
                "Lakukan squat 30 kali sambil berteriak 'Saya seksi'.",
                "Chat mantanmu sekarang dan bilang 'Aku kangen'.",
                "Posting foto paling jelek di galeri ke Story Instagram.",
                "Bicara pakai bahasa planet selama 3 putaran ke depan.",
                "Biarkan seseorang menghapus satu aplikasi di HP-mu."
            ]
        };

        // TRACKING UNTUK ANTI-REPEATING
        let usedChallenges = JSON.parse(localStorage.getItem('tod_used')) || [];

        async function start() {
            nick = document.getElementById('in-nick').value.trim();
            if(!nick) return;
            document.getElementById('v-login').style.display = 'none';
            document.getElementById('v-main').classList.remove('hidden');
            await supa.auth.signInAnonymously();
            
            supa.channel('main').on('postgres_changes', { event: '*', schema: 'public', table: 'Pesan' }, getChat)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'Tantangan' }, () => { getGame(); if(document.getElementById('history-modal').classList.contains('active')) getHistory(); })
                .subscribe();
            getChat(); getGame();
        }

        async function drawChallenge() {
            const display = document.getElementById('display-content');
            const loader = document.getElementById('loading-box');
            const btn = document.getElementById('btn-draw');

            btn.disabled = true;
            display.classList.add('hidden');
            loader.classList.remove('hidden');

            // Simulasi Loading 1.8 detik
            setTimeout(async () => {
                const type = Math.random() > 0.5 ? 'TRUTH' : 'DARE';
                const available = BANK[type].filter(item => !usedChallenges.includes(item));
                
                let chosen;
                if(available.length === 0) {
                    // Jika semua sudah pernah muncul, reset memory
                    usedChallenges = [];
                    chosen = BANK[type][Math.floor(Math.random() * BANK[type].length)];
                } else {
                    chosen = available[Math.floor(Math.random() * available.length)];
                }

                // Simpan ke memory anti-repeat
                usedChallenges.push(chosen);
                localStorage.setItem('tod_used', JSON.stringify(usedChallenges));

                await supa.from('Tantangan').insert([{ tipe: type, isi: chosen, pembuat: nick }]);

                loader.classList.add('hidden');
                display.classList.remove('hidden');
                btn.disabled = false;
            }, 1800);
        }

        async function getGame() {
            const { data } = await supa.from('Tantangan').select('*').order('id', { ascending: false }).limit(1);
            const badge = document.getElementById('g-badge');
            const isi = document.getElementById('g-isi');
            const status = document.getElementById('g-tipe');

            if(data?.[0]) {
                status.innerText = `TANTANGAN DARI ${data[0].pembuat}`;
                badge.innerText = data[0].tipe;
                badge.className = `inline-block px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-tighter mb-2 ${data[0].tipe === 'TRUTH' ? 'bg-indigo-500/20 text-indigo-400' : 'bg-red-500/20 text-red-400'}`;
                badge.classList.remove('hidden');
                isi.innerText = `"${data[0].isi}"`;
            }
        }

        // FUNGSI UMUM LAINNYA
        function toggleMenu() { document.getElementById('main-menu').classList.toggle('active'); }
        async function resetGame() { toggleMenu(); if(confirm("Reset Riwayat Game?")) { localStorage.removeItem('tod_used'); usedChallenges = []; await supa.from('Tantangan').delete().neq('id', 0); } }
        async function resetChat() { toggleMenu(); if(confirm("Bersihkan Chat?")) await supa.from('Pesan').delete().neq('id', 0); }
        function toggleHistory(open) { const m = document.getElementById('history-modal'); if(open) { m.classList.add('active'); getHistory(); } else m.classList.remove('active'); }

        async function getHistory() {
            const { data } = await supa.from('Tantangan').select('*').order('created_at', { ascending: false });
            const list = document.getElementById('history-list');
            list.innerHTML = data?.length ? "" : `<p class="text-center text-white/10 py-10 uppercase text-[10px]">Kosong</p>`;
            data?.forEach(h => {
                const d = document.createElement('div');
                d.className = "p-5 rounded-[2rem] bg-white/[0.02] border border-white/5 mb-4";
                d.innerHTML = `<span class="text-[9px] font-black uppercase ${h.tipe === 'TRUTH' ? 'text-indigo-400' : 'text-red-400'}">${h.tipe}</span><p class="text-sm font-bold text-slate-300 mt-1">"${h.isi}"</p><div class="text-[8px] font-black text-white/20 mt-2">DITARIK OLEH: ${h.pembuat}</div>`;
                list.appendChild(d);
            });
        }

        async function getChat() {
            const { data } = await supa.from('Pesan').select('*').order('created_at', { ascending: false }).limit(30);
            const box = document.getElementById('c-list'); box.innerHTML = "";
            data?.forEach(d => {
                const isMe = d.nama === nick;
                const item = document.createElement('div');
                item.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} w-full group`;
                item.innerHTML = `<span class="text-[8px] text-white/20 font-black mb-1 px-3 uppercase">${d.nama}</span><div class="flex items-end gap-2 max-w-[85%] ${isMe ? 'flex-row-reverse' : 'flex-row'}"><div class="${isMe ? 'my-msg' : 'their-msg'} px-4 py-3 rounded-[1.2rem] text-[13px] border border-white/5 shadow-md">${d.teks}</div></div>`;
                box.appendChild(item);
            });
        }

        async function sendMsg() {
            const i = document.getElementById('c-input'); if(!i.value.trim()) return;
            await supa.from('Pesan').insert([{ nama: nick, teks: i.value }]); i.value = "";
        }
    </script>
</body>
</html>

