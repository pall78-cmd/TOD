<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>T/D - Grey Fog Gathering</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Nanum+Myeongjo:wght@400;700&family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0a0c10;
            --accent-gold: #f1c40f;
            --text-main: #ffffff;
            --mystic-purple: #5b2c91;
            --card-bg: #161b22;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
            outline: none;
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Nanum Myeongjo', serif;
            height: 100dvh;
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            touch-action: manipulation;
        }

        .hall-wrapper {
            width: 100%;
            max-width: 500px;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #0d1117;
            position: relative;
            transform: translateZ(0); /* Hardware Acceleration */
        }

        /* Overlay System with Debugged Z-Index */
        .overlay-layer {
            position: absolute;
            inset: 0;
            background: #0d1117;
            z-index: 1000;
            display: none;
            flex-direction: column;
            padding: 24px;
            animation: overlayFade 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, opacity;
        }

        @keyframes overlayFade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .spiritual-threads {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column-reverse;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .thread-msg {
            margin-bottom: 12px;
            padding: 14px 18px;
            max-width: 85%;
            border-radius: 16px;
            animation: msgSlide 0.3s ease-out forwards;
            position: relative;
        }

        @keyframes msgSlide {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .my-thread { 
            align-self: flex-end; 
            background: linear-gradient(145deg, var(--mystic-purple), #3d1d63);
            border-bottom-right-radius: 4px;
        }

        .others-thread { 
            align-self: flex-start; 
            background: #1c2128; 
            border: 1px solid #30363d;
            border-bottom-left-radius: 4px;
        }

        .sender-name {
            font-family: 'Cinzel', serif;
            font-size: 10px;
            color: var(--accent-gold);
            letter-spacing: 1.2px;
            margin-bottom: 6px;
            display: block;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* Once View UI Update */
        .once-box {
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 12px;
            border: 1px dashed rgba(241, 196, 15, 0.4);
            margin-top: 8px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .btn-reveal {
            background: var(--accent-gold);
            color: #000;
            font-size: 10px;
            font-weight: 900;
            padding: 8px 16px;
            border-radius: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.2);
        }

        .btn-reveal:active { transform: scale(0.92); }

        .tarot-display {
            background: var(--card-bg);
            border: 1px solid rgba(241, 196, 15, 0.2);
            padding: 24px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            margin: 15px;
            transition: transform 0.2s;
        }

        .btn-action {
            background: var(--accent-gold);
            color: #000;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border-radius: 14px;
            transition: all 0.2s;
        }

        .btn-action:active { transform: scale(0.96); opacity: 0.9; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <!-- LAYAR LOGIN -->
    <div id="v-login" class="fixed inset-0 z-[2000] flex items-center justify-center bg-[#0a0c10] p-8">
        <div class="text-center w-full max-w-xs transition-opacity duration-300" id="login-container">
            <h1 class="font-unifraktur text-7xl text-white mb-4">T/D</h1>
            <p class="text-[10px] tracking-[6px] text-accent-gold uppercase mb-12 opacity-80">Kabut Kelabu Memanggil</p>
            <div class="space-y-4">
                <input id="in-nick" type="text" maxlength="15" placeholder="Nama Beyonder..." 
                    class="w-full bg-[#161b22] border-2 border-[#30363d] p-4 text-center rounded-2xl text-white outline-none focus:border-accent-gold transition-colors">
                <button onclick="startApp()" class="w-full py-4 btn-action text-sm">Masuk Altar</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP INTERFACE -->
    <div id="v-main" class="hidden hall-wrapper">
        
        <!-- RIWAYAT OVERLAY (Debugged) -->
        <div id="history-overlay" class="overlay-layer">
            <div class="flex justify-between items-center mb-6 border-b border-[#30363d] pb-4">
                <h2 class="font-cinzel text-accent-gold text-sm tracking-widest">CATATAN TAKDIR</h2>
                <button onclick="closeOverlays()" class="text-white opacity-50 hover:opacity-100 text-2xl p-2">âœ•</button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto no-scrollbar space-y-4"></div>
        </div>

        <!-- PENGATURAN OVERLAY (Debugged) -->
        <div id="menu-overlay" class="overlay-layer justify-center items-center">
            <div class="w-full max-w-xs space-y-4">
                <h3 class="text-center font-cinzel text-accent-gold mb-10 tracking-[5px] text-lg">PENGATURAN</h3>
                
                <button onclick="showHistory()" class="w-full py-5 bg-[#21262d] text-white font-bold rounded-2xl border border-[#30363d] active:scale-95 transition-transform flex items-center justify-center gap-3">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    LIHAT RIWAYAT T/D
                </button>

                <div class="py-4 flex items-center gap-4">
                    <div class="h-px bg-[#30363d] flex-1"></div>
                    <span class="text-[9px] text-gray-500 uppercase tracking-widest">Zona Bahaya</span>
                    <div class="h-px bg-[#30363d] flex-1"></div>
                </div>

                <button onclick="wipeOut('pesan')" class="w-full py-3 bg-red-900/10 text-red-500 font-bold rounded-xl border border-red-900/20 text-[10px] uppercase tracking-widest active:bg-red-900/20">Hapus Semua Pesan</button>
                <button onclick="wipeOut('game')" class="w-full py-3 bg-red-900/10 text-red-500 font-bold rounded-xl border border-red-900/20 text-[10px] uppercase tracking-widest active:bg-red-900/20">Reset Game T/D</button>
                
                <button onclick="closeOverlays()" class="w-full py-4 text-gray-500 text-[10px] tracking-widest mt-12 hover:text-white transition-colors">KEMBALI</button>
            </div>
        </div>

        <!-- HEADER -->
        <header class="p-4 flex justify-between items-center border-b border-[#30363d] bg-[#161b22] sticky top-0 z-[50]">
            <button onclick="toggleMenu(true)" class="text-white/70 p-2"><svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16m-7 6h7"/></svg></button>
            <span class="font-unifraktur text-3xl text-white">T/D</span>
            <button onclick="location.reload()" class="text-white/70 p-2"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg></button>
        </header>

        <!-- GAME AREA -->
        <div class="flex-none">
            <div id="tarot-card" class="tarot-display">
                <span id="q-type" class="text-[9px] font-bold uppercase tracking-[4px] text-accent-gold mb-3 block opacity-60">RAMALAN KABUT</span>
                <p id="q-text" class="text-white text-xl font-bold min-h-[80px] flex items-center justify-center px-4 leading-snug">Goncang altar untuk memunculkan takdir.</p>
                <button id="btn-draw" onclick="drawChallenge()" class="btn-action w-full py-4 mt-6">RAMAL NASIB</button>
            </div>
        </div>

        <!-- MESSAGES -->
        <div id="c-list" class="spiritual-threads no-scrollbar"></div>

        <!-- FOOTER INPUT -->
        <footer class="p-4 bg-[#161b22] border-t border-[#30363d] pb-8">
            <div class="flex items-center gap-3 mb-4 px-1">
                <input type="checkbox" id="check-once" class="w-5 h-5 accent-red-600 rounded cursor-pointer">
                <label for="check-once" class="text-[10px] font-bold text-white/50 uppercase tracking-widest cursor-pointer select-none">Mantra Sekali Lihat</label>
            </div>
            <div class="flex gap-2">
                <button onclick="document.getElementById('in-file').click()" class="bg-[#21262d] text-accent-gold p-4 rounded-2xl active:scale-90 transition-transform"><svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></button>
                <input type="file" id="in-file" class="hidden" onchange="handleFileUpload(this)">
                <input id="c-input" type="text" placeholder="Ketik mantra..." class="flex-1 bg-[#0d1117] px-5 py-4 rounded-2xl text-white border border-[#30363d] focus:border-accent-gold transition-all">
                <button onclick="sendMessage()" class="btn-action px-6 rounded-2xl"><svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
            </div>
        </footer>
    </div>

    <script>
        const CONFIG = {
            URL: 'https://rruxlxoeelxjjjmhafkc.supabase.co',
            KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJydXhseG9lZWx4ampqbWhhZmtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NDU5OTMsImV4cCI6MjA4NTMyMTk5M30.oR2hl_BDD1P6Dmtos2So-aJ_eoFl1-Kwybt6mQnvq0Q',
            QUESTS: {
                TRUTH: ["Siapa orang yang kamu benci di grup ini?", "Rahasia yang paling kamu jaga?", "Kapan terakhir kali kamu menangis?", "Pernah selingkuh atau dikhianati?", "Apa hal paling menjijikkan yang pernah kamu lakukan?", "Siapa orang yang diam-diam kamu kagumi?"],
                DARE: ["Nyanyi lagu dangdut di voice chat/chat", "Kirim foto galeri paling bawah", "VC teman random dan bilang 'aku kangen'", "Push up 10x sambil sebut nama mantan", "Post foto jelek di status WA", "Chat orang yang kamu suka sekarang"]
            }
        };

        const supa = supabase.createClient(CONFIG.URL, CONFIG.KEY);
        let state = { nick: "", rendered: new Set(), isLocked: false };

        async function startApp() {
            const nickIn = document.getElementById('in-nick');
            state.nick = nickIn.value.trim() || "Anonim";
            
            document.getElementById('login-container').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('v-login').classList.add('hidden');
                document.getElementById('v-main').classList.remove('hidden');
            }, 300);

            await supa.auth.signInAnonymously();
            fetchData();

            // Realtime Handlers
            supa.channel('hall').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'Pesan' }, p => renderMsg(p.new))
            .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'Pesan' }, () => {
                document.getElementById('c-list').innerHTML = "";
                state.rendered.clear();
            }).subscribe();

            supa.channel('game').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'Tantangan' }, p => applyGameUI(p.new))
            .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'Tantangan' }, () => {
                document.getElementById('q-text').innerText = "Riwayat takdir telah direset.";
                document.getElementById('q-type').innerText = "RESET";
            }).subscribe();
        }

        async function fetchData() {
            const { data } = await supa.from('Pesan').select('*').order('id', { ascending: false }).limit(35);
            if(data) data.reverse().forEach(renderMsg);
            const { data: g } = await supa.from('Tantangan').select('*').order('id', { ascending: false }).limit(1);
            if(g?.[0]) applyGameUI(g[0]);
        }

        function renderMsg(msg) {
            if(state.rendered.has(msg.id)) return;
            const box = document.getElementById('c-list');
            const isMe = msg.nama === state.nick;
            const isSecret = msg.teks.startsWith('ONCE:');
            const raw = isSecret ? msg.teks.replace('ONCE:', '') : msg.teks;

            const div = document.createElement('div');
            div.className = `thread-msg ${isMe ? 'my-thread' : 'others-thread'}`;
            
            let html = `<span class="sender-name">${msg.nama}</span>`;
            
            if(raw.startsWith('IMG:')) {
                html += `<img src="${raw.replace('IMG:', '')}" class="rounded-xl max-h-64 w-full object-cover mt-2 shadow-lg" loading="lazy">`;
            } else if(isSecret) {
                // Encoding untuk keamanan sederhana
                const safeBase64 = btoa(unescape(encodeURIComponent(raw)));
                html += `
                    <div class="once-box">
                        <button onclick="revealMsg(this, '${safeBase64}')" class="btn-reveal">Pecahkan Segel Rahasia</button>
                    </div>`;
            } else {
                html += `<span class="text-sm md:text-base">${raw}</span>`;
            }

            div.innerHTML = html;
            box.prepend(div);
            state.rendered.add(msg.id);
            if(box.children.length > 60) box.removeChild(box.lastChild);
        }

        function revealMsg(btn, b64) {
            try {
                const text = decodeURIComponent(escape(atob(b64)));
                const container = btn.parentElement;
                container.innerHTML = `<span class="text-white italic animate-pulse">"${text}"</span>`;
                container.style.background = "transparent";
                container.style.border = "none";
            } catch(e) { console.error(e); }
        }

        async function drawChallenge() {
            if(state.isLocked) return;
            state.isLocked = true;
            
            const btn = document.getElementById('btn-draw');
            const text = document.getElementById('q-text');

            btn.disabled = true;
            text.innerText = "MENGUNDI NASIB...";

            try {
                const type = Math.random() > 0.5 ? 'TRUTH' : 'DARE';
                const list = CONFIG.QUESTS[type];
                const quest = list[Math.floor(Math.random() * list.length)];
                await supa.from('Tantangan').insert([{ tipe: type, isi: quest, pembuat: state.nick }]);
            } finally {
                setTimeout(() => {
                    state.isLocked = false;
                    btn.disabled = false;
                }, 1200);
            }
        }

        function applyGameUI(data) {
            document.getElementById('q-type').innerText = `TAKDIR: ${data.tipe}`;
            document.getElementById('q-text').innerText = `"${data.isi}"`;
        }

        async function sendMessage() {
            const input = document.getElementById('c-input');
            const once = document.getElementById('check-once');
            let val = input.value.trim();
            if(!val) return;

            if(once.checked) { val = `ONCE:${val}`; once.checked = false; }
            input.value = "";
            await supa.from('Pesan').insert([{ nama: state.nick, teks: val }]);
        }

        async function handleFileUpload(el) {
            const file = el.files[0]; if(!file) return;
            const path = `file_${Date.now()}.${file.name.split('.').pop()}`;
            const { error } = await supa.storage.from('bukti').upload(path, file);
            if(!error) {
                const { data } = supa.storage.from('bukti').getPublicUrl(path);
                await supa.from('Pesan').insert([{ nama: state.nick, teks: `IMG:${data.publicUrl}` }]);
            }
            el.value = "";
        }

        async function showHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = "<div class='text-center py-20 text-accent-gold animate-pulse font-cinzel'>MEMBUKA GERBANG MASA LALU...</div>";
            
            // Debugged UI Toggle: Pastikan menu overlay tutup dulu atau tumpuk dengan benar
            document.getElementById('history-overlay').style.display = 'flex';
            
            try {
                const { data, error } = await supa.from('Tantangan').select('*').order('id', { ascending: false }).limit(40);
                if(error) throw error;
                
                list.innerHTML = data?.map(i => `
                    <div class="p-5 bg-[#1c2128] border border-[#30363d] rounded-2xl animate-fade-in">
                        <div class="flex justify-between text-[10px] text-accent-gold mb-3 font-bold opacity-60">
                            <span>${i.tipe}</span><span>BEYONDER: ${i.pembuat}</span>
                        </div>
                        <p class="text-white text-base font-medium leading-relaxed italic">"${i.isi}"</p>
                    </div>
                `).join('') || "<div class='text-center py-20 text-gray-600 italic'>Belum ada sejarah yang tertulis.</div>";
            } catch(e) {
                list.innerHTML = "<div class='text-center py-20 text-red-500'>Gagal memanggil data roh.</div>";
            }
        }

        function toggleMenu(s) { document.getElementById('menu-overlay').style.display = s ? 'flex' : 'none'; }
        
        function closeOverlays() { 
            document.getElementById('menu-overlay').style.display = 'none'; 
            document.getElementById('history-overlay').style.display = 'none'; 
        }

        async function wipeOut(mode) {
            if(!confirm("Hapus semua jejak ini secara permanen?")) return;
            try {
                if(mode === 'pesan') {
                    await supa.from('Pesan').delete().neq('id', 0);
                } else {
                    await supa.from('Tantangan').delete().neq('id', 0);
                }
                closeOverlays();
            } catch (e) { alert("Ritual gagal."); }
        }

        document.getElementById('c-input').addEventListener('keypress', e => { if(e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>

