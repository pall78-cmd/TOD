<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>T/D - High Res Privacy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Nanum+Myeongjo:wght@400;700&family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0a0c10;
            --accent-gold: #f1c40f;
            --text-main: #ffffff;
            --mystic-purple: #5b2c91;
            --card-bg: #161b22;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Nanum Myeongjo', serif;
            height: 100dvh;
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }

        .hall-wrapper {
            width: 100%;
            max-width: 500px;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #0d1117;
            position: relative;
        }

        .overlay-layer {
            position: absolute;
            inset: 0;
            background: rgba(10, 12, 16, 0.98);
            z-index: 1000;
            display: none;
            flex-direction: column;
            padding: 24px;
            backdrop-filter: blur(20px);
            animation: overlayFade 0.3s ease-out forwards;
        }

        @keyframes overlayFade {
            from { opacity: 0; transform: scale(1.02); }
            to { opacity: 1; transform: scale(1); }
        }

        .spiritual-threads {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column-reverse;
            scrollbar-width: none;
        }

        .thread-msg {
            margin-bottom: 16px;
            padding: 14px 18px;
            max-width: 85%;
            border-radius: 18px;
            position: relative;
        }

        .my-thread { 
            align-self: flex-end; 
            background: linear-gradient(135deg, var(--mystic-purple), #3d1d63);
            border-bottom-right-radius: 4px;
        }

        .others-thread { 
            align-self: flex-start; 
            background: #1c2128; 
            border: 1px solid #30363d;
            border-bottom-left-radius: 4px;
        }

        .sender-name {
            font-family: 'Cinzel', serif;
            font-size: 10px;
            color: var(--accent-gold);
            letter-spacing: 1.5px;
            margin-bottom: 4px;
            display: block;
            font-weight: 700;
        }

        .proof-box {
            background: rgba(0,0,0,0.4);
            border: 1px dashed var(--accent-gold);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            margin-top: 5px;
        }

        .btn-unlock {
            background: var(--accent-gold);
            color: #000;
            font-weight: 900;
            font-size: 10px;
            padding: 8px 15px;
            border-radius: 6px;
            text-transform: uppercase;
        }

        .tarot-display {
            background: var(--card-bg);
            border: 1px solid rgba(241, 196, 15, 0.15);
            padding: 25px 20px;
            border-radius: 20px;
            text-align: center;
            margin: 10px 15px;
        }

        .btn-action {
            background: var(--accent-gold);
            color: #000;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 12px;
        }

        .setting-item {
            background: #1c2128;
            border: 1px solid #30363d;
            padding: 15px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        #image-preview-container {
            display: none;
            position: absolute;
            bottom: 120px;
            left: 20px;
            right: 20px;
            background: #161b22;
            border: 1px solid var(--accent-gold);
            padding: 12px;
            border-radius: 15px;
            z-index: 100;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="v-login" class="fixed inset-0 z-[2000] flex items-center justify-center bg-[#0a0c10] p-8">
        <div class="text-center w-full max-w-xs">
            <h1 class="font-unifraktur text-7xl text-white mb-2">T/D</h1>
            <p class="text-[10px] tracking-[5px] text-accent-gold uppercase mb-10">HIGH RES PRIVACY</p>
            <input id="in-nick" type="text" maxlength="12" placeholder="Nama..." class="w-full bg-[#161b22] border-2 border-[#30363d] p-4 text-center rounded-2xl text-white outline-none mb-4 focus:border-accent-gold">
            <button onclick="startApp()" class="w-full py-4 btn-action">Masuk Altar</button>
        </div>
    </div>

    <!-- MAIN -->
    <div id="v-main" class="hidden hall-wrapper">
        
        <div id="menu-overlay" class="overlay-layer">
            <div class="flex justify-between items-center mb-8">
                <h3 class="font-cinzel text-accent-gold tracking-[3px]">PENGATURAN</h3>
                <button onclick="toggleMenu(false)" class="text-white opacity-50 text-2xl">‚úï</button>
            </div>
            <div class="space-y-3">
                <button onclick="showHistory()" class="setting-item w-full">
                    <span class="text-sm font-bold">Riwayat Altar</span>
                    <span>üìú</span>
                </button>
                <div class="h-px bg-[#30363d] my-4"></div>
                <button onclick="wipeOut('pesan')" class="setting-item w-full border-red-900/30">
                    <span class="text-red-500 text-sm font-bold">Hapus Semua Chat</span>
                    <span>üóëÔ∏è</span>
                </button>
                <button onclick="wipeOut('game')" class="setting-item w-full border-red-900/30">
                    <span class="text-red-500 text-sm font-bold">Reset Altar Game</span>
                    <span>‚ôªÔ∏è</span>
                </button>
            </div>
        </div>

        <div id="history-overlay" class="overlay-layer">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-cinzel text-accent-gold text-xs">LOG TAKDIR</h3>
                <button onclick="document.getElementById('history-overlay').style.display='none'" class="text-white opacity-50 text-xl">‚úï</button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto no-scrollbar space-y-2 text-[11px]"></div>
        </div>

        <header class="p-4 flex justify-between items-center border-b border-[#30363d] bg-[#161b22]">
            <button onclick="toggleMenu(true)" class="text-accent-gold opacity-70">‚öô</button>
            <span class="font-unifraktur text-2xl">T/D Altar</span>
            <button onclick="location.reload()" class="text-white opacity-50">‚ü≥</button>
        </header>

        <div class="flex-none">
            <div id="tarot-card" class="tarot-display">
                <span id="q-type" class="text-[9px] font-bold tracking-[3px] text-accent-gold/50 mb-3 block">MENANTI TAKDIR</span>
                <p id="q-text" class="text-white text-lg font-bold min-h-[70px] flex items-center justify-center italic px-2">"Sentuh untuk mengacak nasib..."</p>
                <button id="btn-draw" onclick="drawFate()" class="btn-action w-full py-4 mt-4">ACAK</button>
            </div>
        </div>

        <div id="c-list" class="spiritual-threads no-scrollbar"></div>

        <!-- IMAGE PREVIEW -->
        <div id="image-preview-container">
            <div class="flex items-center gap-3">
                <div id="preview-box" class="w-10 h-10 bg-gray-800 rounded-lg bg-cover bg-center border border-white/20"></div>
                <div class="flex flex-col">
                    <span class="text-[10px] text-accent-gold font-bold">GAMBAR SIAP (HD)</span>
                    <span class="text-[8px] text-white/40">Otomatis terkompresi & aman</span>
                </div>
            </div>
            <button onclick="cancelImage()" class="text-red-500 text-xs font-bold px-3 py-1">BATAL</button>
        </div>

        <footer class="p-4 bg-[#161b22] border-t border-[#30363d] pb-6">
            <div class="flex items-center gap-3 mb-3">
                <input type="checkbox" id="check-once" checked class="w-4 h-4 accent-yellow-600 bg-gray-900 border-none rounded">
                <label for="check-once" class="text-[9px] font-bold text-white/50 uppercase tracking-widest cursor-pointer">Segel Sekali Lihat (Auto-Destruct)</label>
            </div>
            <div class="flex gap-2">
                <label class="bg-[#0d1117] border border-[#30363d] px-4 py-4 rounded-xl flex items-center justify-center cursor-pointer transition-colors active:bg-gray-800">
                    <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFile(this)">
                    <span class="text-xl">üñºÔ∏è</span>
                </label>
                <input id="c-input" type="text" placeholder="Tulis pesan..." class="flex-1 bg-[#0d1117] px-4 py-4 rounded-xl text-white border border-[#30363d]">
                <button id="btn-send" onclick="sendMessage()" class="btn-action px-5 rounded-xl">‚û§</button>
            </div>
        </footer>
    </div>

    <script>
        const QUESTS = {
            TRUTH: [
                "Siapa teman yang paling sering kamu cari saat bosan?", "Apa makanan paling aneh yang pernah kamu coba?", "Pernahkah kamu salah kirim chat ke orang yang kamu suka?", "Apa film yang paling bikin kamu menangis?", "Apa satu hal yang ingin kamu capai bulan ini?", "Siapa orang pertama yang kamu hubungi saat bangun tidur?", "Apa ketakutan paling konyol yang kamu miliki?", "Apa hobi yang ingin kamu pelajari kalau punya banyak waktu?", "Apa kenangan masa kecil yang paling tidak bisa kamu lupakan?", "Apa hal favoritmu tentang dirimu sendiri?"
            ],
            DARE: [
                "Tunjukkan stiker WhatsApp yang paling sering kamu pakai.", "Kirim pesan 'Hai' ke orang ke-3 di daftar chatmu.", "Ambil foto benda warna merah di sekitarmu dan kirim.", "Nyanyi lagu favoritmu lewat voice note sebentar saja.", "Ganti nama panggilanmu jadi 'Si Hebat' selama 10 menit.", "Berikan satu fakta menarik tentang hari ini.", "Ceritakan lelucon tergaring yang kamu punya.", "Tunjukkan wallpaper kunci layar HP-mu.", "Tulis 'Aku suka tantangan' di status WhatsApp-mu.", "Sebutkan 3 hal yang kamu syukuri hari ini."
            ]
        };

        const supa = supabase.createClient(
            'https://rruxlxoeelxjjjmhafkc.supabase.co', 
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJydXhseG9lZWx4ampqbWhhZmtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NDU5OTMsImV4cCI6MjA4NTMyMTk5M30.oR2hl_BDD1P6Dmtos2So-aJ_eoFl1-Kwybt6mQnvq0Q'
        );

        let state = { nick: "", currentFile: null, rendered: new Set() };

        async function startApp() {
            const n = document.getElementById('in-nick').value.trim();
            if(!n) return;
            state.nick = n;
            document.getElementById('v-login').classList.add('hidden');
            document.getElementById('v-main').classList.remove('hidden');
            await supa.auth.signInAnonymously();
            fetchInitial();
            setupRealtime();
        }

        // FUNGSI KOMPRESI GAMBAR (PENTING UNTUK 10MB+)
        function handleFile(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Batasi dimensi maksimum agar file tidak membengkak
                    const max_size = 1200;
                    if (width > height) {
                        if (width > max_size) {
                            height *= max_size / width;
                            width = max_size;
                        }
                    } else {
                        if (height > max_size) {
                            width *= max_size / height;
                            height = max_size;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Konversi ke JPEG dengan kompresi 0.7 untuk keseimbangan kualitas & ukuran
                    const compressed = canvas.toDataURL('image/jpeg', 0.7);
                    state.currentFile = compressed;
                    
                    document.getElementById('preview-box').style.backgroundImage = `url(${compressed})`;
                    document.getElementById('image-preview-container').style.display = 'flex';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function cancelImage() {
            state.currentFile = null;
            document.getElementById('file-input').value = "";
            document.getElementById('image-preview-container').style.display = 'none';
        }

        async function sendMessage() {
            const input = document.getElementById('c-input');
            const once = document.getElementById('check-once');
            const btn = document.getElementById('btn-send');
            let txt = input.value.trim();
            let img = state.currentFile;

            if(!txt && !img) return;

            btn.disabled = true;
            btn.innerHTML = "‚åõ";

            await supa.from('Pesan').insert([{ 
                nama: state.nick, 
                teks: txt,
                gambar: img,
                is_once: once.checked
            }]);
            
            input.value = "";
            btn.disabled = false;
            btn.innerHTML = "‚û§";
            cancelImage();
        }

        function renderMsg(msg) {
            if(state.rendered.has(msg.id)) return;
            const isMe = msg.nama === state.nick;
            const box = document.getElementById('c-list');
            const div = document.createElement('div');
            div.className = `thread-msg ${isMe ? 'my-thread' : 'others-thread'}`;
            
            let content = `<span class="sender-name">${msg.nama}</span>`;
            
            if(msg.is_once) {
                content += `
                    <div class="proof-box" id="once-${msg.id}">
                        <p class="text-[9px] text-white/40 mb-2 uppercase tracking-tighter">üîí SEGEL SEKALI LIHAT</p>
                        <button onclick="revealOnce('${msg.id}', '${msg.teks || ''}', '${msg.gambar || ''}')" class="btn-unlock">Buka Segel</button>
                    </div>`;
            } else {
                if(msg.teks) content += `<p class="text-sm">${msg.teks}</p>`;
                if(msg.gambar) content += `<img src="${msg.gambar}" class="w-full rounded-lg mt-2 border border-white/10 shadow-lg">`;
            }

            div.innerHTML = content;
            box.prepend(div);
            state.rendered.add(msg.id);
        }

        function revealOnce(id, teks, gambar) {
            const container = document.getElementById(`once-${id}`);
            let html = "";
            if(teks) html += `<p class="text-sm italic text-white animate-pulse">"${teks}"</p>`;
            if(gambar) html += `<img src="${gambar}" class="w-full rounded-lg mt-2 shadow-xl" style="display:block">`;
            
            container.innerHTML = html;
            // Timer penghancuran otomatis
            setTimeout(() => {
                container.innerHTML = `<p class="text-[9px] text-red-500 font-bold italic">Segel hancur. Bukti telah musnah.</p>`;
                container.style.opacity = "0.2";
            }, 8000);
        }

        async function drawFate() {
            const type = Math.random() > 0.5 ? 'TRUTH' : 'DARE';
            const pool = QUESTS[type];
            const q = pool[Math.floor(Math.random() * pool.length)];
            await supa.from('Tantangan').insert([{ tipe: type, isi: q, pembuat: state.nick }]);
        }

        function applyGame(data) {
            document.getElementById('q-type').innerText = `${data.tipe} - DITARIK OLEH ${data.pembuat}`;
            document.getElementById('q-text').innerText = `"${data.isi}"`;
        }

        function setupRealtime() {
            supa.channel('room').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'Pesan' }, p => renderMsg(p.new))
            .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'Pesan' }, () => {
                document.getElementById('c-list').innerHTML = "";
                state.rendered.clear();
            }).subscribe();

            supa.channel('altar').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'Tantangan' }, p => applyGame(p.new))
            .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'Tantangan' }, () => {
                document.getElementById('q-text').innerText = "Altar Kosong.";
            }).subscribe();
        }

        async function fetchInitial() {
            const { data: msgs } = await supa.from('Pesan').select('*').order('id', { ascending: false }).limit(20);
            if(msgs) msgs.reverse().forEach(renderMsg);
            const { data: game } = await supa.from('Tantangan').select('*').order('id', { ascending: false }).limit(1);
            if(game?.[0]) applyGame(game[0]);
        }

        function toggleMenu(s) { document.getElementById('menu-overlay').style.display = s ? 'flex' : 'none'; }
        
        async function showHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = "Memanggil roh masa lalu...";
            document.getElementById('history-overlay').style.display = 'flex';
            const { data } = await supa.from('Tantangan').select('*').order('id', { ascending: false }).limit(15);
            list.innerHTML = data?.map(h => `
                <div class="border-b border-[#30363d] py-3">
                    <div class="flex justify-between text-[9px] font-bold text-accent-gold mb-1">
                        <span>${h.tipe}</span><span>${h.pembuat}</span>
                    </div>
                    <p class="italic text-gray-400">"${h.isi}"</p>
                </div>
            `).join('') || "Belum ada log.";
        }

        async function wipeOut(t) {
            if(!confirm("Hapus semua jejak selamanya?")) return;
            await supa.from(t === 'pesan' ? 'Pesan' : 'Tantangan').delete().neq('id', 0);
            toggleMenu(false);
        }

        document.getElementById('c-input').addEventListener('keypress', e => { if(e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>

